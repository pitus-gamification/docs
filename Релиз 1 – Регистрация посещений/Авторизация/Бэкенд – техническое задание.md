- [1. Введение](#1-%D0%92%D0%B2%D0%B5%D0%B4%D0%B5%D0%BD%D0%B8%D0%B5)
	- [1.1. Цель документа](#11-%D0%A6%D0%B5%D0%BB%D1%8C-%D0%B4%D0%BE%D0%BA%D1%83%D0%BC%D0%B5%D0%BD%D1%82%D0%B0)
	- [1.2. Область применения](#12-%D0%9E%D0%B1%D0%BB%D0%B0%D1%81%D1%82%D1%8C-%D0%BF%D1%80%D0%B8%D0%BC%D0%B5%D0%BD%D0%B5%D0%BD%D0%B8%D1%8F)
- [2. Общее описание](#2-%D0%9E%D0%B1%D1%89%D0%B5%D0%B5-%D0%BE%D0%BF%D0%B8%D1%81%D0%B0%D0%BD%D0%B8%D0%B5)
	- [2.1. Перспектива продукта](#21-%D0%9F%D0%B5%D1%80%D1%81%D0%BF%D0%B5%D0%BA%D1%82%D0%B8%D0%B2%D0%B0-%D0%BF%D1%80%D0%BE%D0%B4%D1%83%D0%BA%D1%82%D0%B0)
	- [2.2. Основные функции модуля "Авторизация"](#22-%D0%9E%D1%81%D0%BD%D0%BE%D0%B2%D0%BD%D1%8B%D0%B5-%D1%84%D1%83%D0%BD%D0%BA%D1%86%D0%B8%D0%B8-%D0%BC%D0%BE%D0%B4%D1%83%D0%BB%D1%8F-%D0%90%D0%B2%D1%82%D0%BE%D1%80%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D1%8F)
	- [2.3. Классы пользователей](#23-%D0%9A%D0%BB%D0%B0%D1%81%D1%81%D1%8B-%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D0%BE%D0%B2%D0%B0%D1%82%D0%B5%D0%BB%D0%B5%D0%B9)
- [3. Функциональные требования](#3-%D0%A4%D1%83%D0%BD%D0%BA%D1%86%D0%B8%D0%BE%D0%BD%D0%B0%D0%BB%D1%8C%D0%BD%D1%8B%D0%B5-%D1%82%D1%80%D0%B5%D0%B1%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F)
	- [3.1. Аутентификация пользователей](#31-%D0%90%D1%83%D1%82%D0%B5%D0%BD%D1%82%D0%B8%D1%84%D0%B8%D0%BA%D0%B0%D1%86%D0%B8%D1%8F-%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D0%BE%D0%B2%D0%B0%D1%82%D0%B5%D0%BB%D0%B5%D0%B9)
		- [3.1.1. Стандартная аутентификация](#311-%D0%A1%D1%82%D0%B0%D0%BD%D0%B4%D0%B0%D1%80%D1%82%D0%BD%D0%B0%D1%8F-%D0%B0%D1%83%D1%82%D0%B5%D0%BD%D1%82%D0%B8%D1%84%D0%B8%D0%BA%D0%B0%D1%86%D0%B8%D1%8F)
		- [3.1.2. Аутентификация через Telegram](#312-%D0%90%D1%83%D1%82%D0%B5%D0%BD%D1%82%D0%B8%D1%84%D0%B8%D0%BA%D0%B0%D1%86%D0%B8%D1%8F-%D1%87%D0%B5%D1%80%D0%B5%D0%B7-telegram)
		- [3.1.3. Дополнительная аутентификация для модераторов и администраторов](#313-%D0%94%D0%BE%D0%BF%D0%BE%D0%BB%D0%BD%D0%B8%D1%82%D0%B5%D0%BB%D1%8C%D0%BD%D0%B0%D1%8F-%D0%B0%D1%83%D1%82%D0%B5%D0%BD%D1%82%D0%B8%D1%84%D0%B8%D0%BA%D0%B0%D1%86%D0%B8%D1%8F-%D0%B4%D0%BB%D1%8F-%D0%BC%D0%BE%D0%B4%D0%B5%D1%80%D0%B0%D1%82%D0%BE%D1%80%D0%BE%D0%B2-%D0%B8-%D0%B0%D0%B4%D0%BC%D0%B8%D0%BD%D0%B8%D1%81%D1%82%D1%80%D0%B0%D1%82%D0%BE%D1%80%D0%BE%D0%B2)
	- [3.2. Управление сессиями](#32-%D0%A3%D0%BF%D1%80%D0%B0%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5-%D1%81%D0%B5%D1%81%D1%81%D0%B8%D1%8F%D0%BC%D0%B8)
	- [3.3. Привязка Telegram ID к пользователю](#33-%D0%9F%D1%80%D0%B8%D0%B2%D1%8F%D0%B7%D0%BA%D0%B0-telegram-id-%D0%BA-%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D0%BE%D0%B2%D0%B0%D1%82%D0%B5%D0%BB%D1%8E)
	- [3.4. Интеграция с модулем "Доступы"](#34-%D0%98%D0%BD%D1%82%D0%B5%D0%B3%D1%80%D0%B0%D1%86%D0%B8%D1%8F-%D1%81-%D0%BC%D0%BE%D0%B4%D1%83%D0%BB%D0%B5%D0%BC-%D0%94%D0%BE%D1%81%D1%82%D1%83%D0%BF%D1%8B)
- [4. Нефункциональные требования](#4-%D0%9D%D0%B5%D1%84%D1%83%D0%BD%D0%BA%D1%86%D0%B8%D0%BE%D0%BD%D0%B0%D0%BB%D1%8C%D0%BD%D1%8B%D0%B5-%D1%82%D1%80%D0%B5%D0%B1%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F)
	- [4.1. Безопасность](#41-%D0%91%D0%B5%D0%B7%D0%BE%D0%BF%D0%B0%D1%81%D0%BD%D0%BE%D1%81%D1%82%D1%8C)
	- [4.2. Производительность](#42-%D0%9F%D1%80%D0%BE%D0%B8%D0%B7%D0%B2%D0%BE%D0%B4%D0%B8%D1%82%D0%B5%D0%BB%D1%8C%D0%BD%D0%BE%D1%81%D1%82%D1%8C)
	- [4.3. Масштабируемость](#43-%D0%9C%D0%B0%D1%81%D1%88%D1%82%D0%B0%D0%B1%D0%B8%D1%80%D1%83%D0%B5%D0%BC%D0%BE%D1%81%D1%82%D1%8C)
	- [4.4. Надежность и отказоустойчивость](#44-%D0%9D%D0%B0%D0%B4%D0%B5%D0%B6%D0%BD%D0%BE%D1%81%D1%82%D1%8C-%D0%B8-%D0%BE%D1%82%D0%BA%D0%B0%D0%B7%D0%BE%D1%83%D1%81%D1%82%D0%BE%D0%B9%D1%87%D0%B8%D0%B2%D0%BE%D1%81%D1%82%D1%8C)
	- [4.5. Документирование](#45-%D0%94%D0%BE%D0%BA%D1%83%D0%BC%D0%B5%D0%BD%D1%82%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5)
- [5. Требования к данным](#5-%D0%A2%D1%80%D0%B5%D0%B1%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F-%D0%BA-%D0%B4%D0%B0%D0%BD%D0%BD%D1%8B%D0%BC)
	- [5.1. Модель данных](#51-%D0%9C%D0%BE%D0%B4%D0%B5%D0%BB%D1%8C-%D0%B4%D0%B0%D0%BD%D0%BD%D1%8B%D1%85)
		- [Таблица `users`](#%D0%A2%D0%B0%D0%B1%D0%BB%D0%B8%D1%86%D0%B0-users)
		- [Таблица `user_telegram`](#%D0%A2%D0%B0%D0%B1%D0%BB%D0%B8%D1%86%D0%B0-user_telegram)
	- [5.2. Требования к базе данных](#52-%D0%A2%D1%80%D0%B5%D0%B1%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F-%D0%BA-%D0%B1%D0%B0%D0%B7%D0%B5-%D0%B4%D0%B0%D0%BD%D0%BD%D1%8B%D1%85)
- [6. Спецификация API](#6-%D0%A1%D0%BF%D0%B5%D1%86%D0%B8%D1%84%D0%B8%D0%BA%D0%B0%D1%86%D0%B8%D1%8F-api)
	- [6.1. Эндпоинты для аутентификации](#61-%D0%AD%D0%BD%D0%B4%D0%BF%D0%BE%D0%B8%D0%BD%D1%82%D1%8B-%D0%B4%D0%BB%D1%8F-%D0%B0%D1%83%D1%82%D0%B5%D0%BD%D1%82%D0%B8%D1%84%D0%B8%D0%BA%D0%B0%D1%86%D0%B8%D0%B8)
		- [6.1.1. Стандартная аутентификация](#611-%D0%A1%D1%82%D0%B0%D0%BD%D0%B4%D0%B0%D1%80%D1%82%D0%BD%D0%B0%D1%8F-%D0%B0%D1%83%D1%82%D0%B5%D0%BD%D1%82%D0%B8%D1%84%D0%B8%D0%BA%D0%B0%D1%86%D0%B8%D1%8F)
		- [6.1.2. Аутентификация через Telegram](#612-%D0%90%D1%83%D1%82%D0%B5%D0%BD%D1%82%D0%B8%D1%84%D0%B8%D0%BA%D0%B0%D1%86%D0%B8%D1%8F-%D1%87%D0%B5%D1%80%D0%B5%D0%B7-telegram)
		- [6.1.3. Дополнительная аутентификация для модераторов и администраторов](#613-%D0%94%D0%BE%D0%BF%D0%BE%D0%BB%D0%BD%D0%B8%D1%82%D0%B5%D0%BB%D1%8C%D0%BD%D0%B0%D1%8F-%D0%B0%D1%83%D1%82%D0%B5%D0%BD%D1%82%D0%B8%D1%84%D0%B8%D0%BA%D0%B0%D1%86%D0%B8%D1%8F-%D0%B4%D0%BB%D1%8F-%D0%BC%D0%BE%D0%B4%D0%B5%D1%80%D0%B0%D1%82%D0%BE%D1%80%D0%BE%D0%B2-%D0%B8-%D0%B0%D0%B4%D0%BC%D0%B8%D0%BD%D0%B8%D1%81%D1%82%D1%80%D0%B0%D1%82%D0%BE%D1%80%D0%BE%D0%B2)
	- [6.2. Эндпоинты для управления сессиями](#62-%D0%AD%D0%BD%D0%B4%D0%BF%D0%BE%D0%B8%D0%BD%D1%82%D1%8B-%D0%B4%D0%BB%D1%8F-%D1%83%D0%BF%D1%80%D0%B0%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D1%8F-%D1%81%D0%B5%D1%81%D1%81%D0%B8%D1%8F%D0%BC%D0%B8)
		- [6.2.1. Получение текущих доступов пользователя](#621-%D0%9F%D0%BE%D0%BB%D1%83%D1%87%D0%B5%D0%BD%D0%B8%D0%B5-%D1%82%D0%B5%D0%BA%D1%83%D1%89%D0%B8%D1%85-%D0%B4%D0%BE%D1%81%D1%82%D1%83%D0%BF%D0%BE%D0%B2-%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D0%BE%D0%B2%D0%B0%D1%82%D0%B5%D0%BB%D1%8F)
	- [6.3. Аутентификация и авторизация](#63-%D0%90%D1%83%D1%82%D0%B5%D0%BD%D1%82%D0%B8%D1%84%D0%B8%D0%BA%D0%B0%D1%86%D0%B8%D1%8F-%D0%B8-%D0%B0%D0%B2%D1%82%D0%BE%D1%80%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D1%8F)
- [7. Архитектурные решения](#7-%D0%90%D1%80%D1%85%D0%B8%D1%82%D0%B5%D0%BA%D1%82%D1%83%D1%80%D0%BD%D1%8B%D0%B5-%D1%80%D0%B5%D1%88%D0%B5%D0%BD%D0%B8%D1%8F)
	- [7.1. Сервисная архитектура](#71-%D0%A1%D0%B5%D1%80%D0%B2%D0%B8%D1%81%D0%BD%D0%B0%D1%8F-%D0%B0%D1%80%D1%85%D0%B8%D1%82%D0%B5%D0%BA%D1%82%D1%83%D1%80%D0%B0)
	- [7.2. Подготовка к будущим функционалам](#72-%D0%9F%D0%BE%D0%B4%D0%B3%D0%BE%D1%82%D0%BE%D0%B2%D0%BA%D0%B0-%D0%BA-%D0%B1%D1%83%D0%B4%D1%83%D1%89%D0%B8%D0%BC-%D1%84%D1%83%D0%BD%D0%BA%D1%86%D0%B8%D0%BE%D0%BD%D0%B0%D0%BB%D0%B0%D0%BC)
- [8. Требования к безопасности](#8-%D0%A2%D1%80%D0%B5%D0%B1%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F-%D0%BA-%D0%B1%D0%B5%D0%B7%D0%BE%D0%BF%D0%B0%D1%81%D0%BD%D0%BE%D1%81%D1%82%D0%B8)
- [9. Требования к тестированию](#9-%D0%A2%D1%80%D0%B5%D0%B1%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F-%D0%BA-%D1%82%D0%B5%D1%81%D1%82%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D1%8E)
	- [9.1. Функциональное тестирование](#91-%D0%A4%D1%83%D0%BD%D0%BA%D1%86%D0%B8%D0%BE%D0%BD%D0%B0%D0%BB%D1%8C%D0%BD%D0%BE%D0%B5-%D1%82%D0%B5%D1%81%D1%82%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5)
	- [9.2. Нагрузочное тестирование](#92-%D0%9D%D0%B0%D0%B3%D1%80%D1%83%D0%B7%D0%BE%D1%87%D0%BD%D0%BE%D0%B5-%D1%82%D0%B5%D1%81%D1%82%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5)
	- [9.3. Безопасностное тестирование](#93-%D0%91%D0%B5%D0%B7%D0%BE%D0%BF%D0%B0%D1%81%D0%BD%D0%BE%D1%81%D1%82%D0%BD%D0%BE%D0%B5-%D1%82%D0%B5%D1%81%D1%82%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5)
- [10. План реализации](#10-%D0%9F%D0%BB%D0%B0%D0%BD-%D1%80%D0%B5%D0%B0%D0%BB%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D0%B8)
	- [10.1. Этапы проекта](#101-%D0%AD%D1%82%D0%B0%D0%BF%D1%8B-%D0%BF%D1%80%D0%BE%D0%B5%D0%BA%D1%82%D0%B0)
	- [10.2. Сроки и ресурсы](#102-%D0%A1%D1%80%D0%BE%D0%BA%D0%B8-%D0%B8-%D1%80%D0%B5%D1%81%D1%83%D1%80%D1%81%D1%8B)
- [11. Дополнительные замечания](#11-%D0%94%D0%BE%D0%BF%D0%BE%D0%BB%D0%BD%D0%B8%D1%82%D0%B5%D0%BB%D1%8C%D0%BD%D1%8B%D0%B5-%D0%B7%D0%B0%D0%BC%D0%B5%D1%87%D0%B0%D0%BD%D0%B8%D1%8F)

## 1. Введение

### 1.1. Цель документа

Определить требования и спецификации для разработки бэкенд-функционала модуля **"Авторизация"** в рамках первого релиза цифрового сервиса по автоматизации системы регистрации посещений мероприятий в университете.

### 1.2. Область применения

Документ предназначен для команды разработчиков бэкенда и тестировщиков, участвующих в реализации модуля **"Авторизация"**.

---

## 2. Общее описание

### 2.1. Перспектива продукта

Модуль **"Авторизация"** обеспечивает механизм аутентификации и авторизации пользователей системы. Он поддерживает как стандартную аутентификацию (с использованием логина и пароля), так и аутентификацию через внешние сервисы, такие как Telegram. Модуль интегрируется с модулем **"Доступы"**, обеспечивая гибкую и масштабируемую систему управления доступом пользователей к различным функциям системы.

### 2.2. Основные функции модуля "Авторизация"

- Регистрация и аутентификация пользователей.
- Аутентификация через Telegram.
- Привязка Telegram ID к пользователю.
- Управление сессиями пользователей.
- Интеграция с модулем "Доступы" для проверки прав доступа.
- Обеспечение возможности существования пользователей только через Telegram ID.
- Обеспечение возможности добавления логина и пароля для пользователей при необходимости (например, при назначении ролей модераторов и администраторов).
- Защита от несанкционированного доступа и обеспечение безопасности данных.

### 2.3. Классы пользователей

**Классы пользователей** являются отражением реального бизнес процесса, но в коде все пользователи равны и система оперирует исключительно доступами.

- **Администраторы:** Имеют право управлять доступами и назначать их пользователям, а также имеют доступ к административным функциям системы.
- **Модераторы:** Могут обладать определенными доступами, связанными с проведением мероприятий и управлением ими.
- **Студенты:** Обычно обладают минимальными доступами, необходимыми для участия в мероприятиях и управления своими данными.

---

## 3. Функциональные требования

### 3.1. Аутентификация пользователей

#### 3.1.1. Стандартная аутентификация

- **Описание:** Пользователь регистрируется и входит в систему, используя логин и пароль.
- **Требования:**
  - Возможность регистрации нового пользователя с уникальным логином.
  - Хранение паролей в зашифрованном виде (например, с использованием bcrypt).
  - Валидация данных при регистрации и входе.
  - Генерация и выдача JWT-токенов для аутентифицированных пользователей.
  - Обработка ошибок при некорректных данных (например, неверный пароль, уже зарегистрированный логин).
  - Поля `login` и `password_hash` являются необязательными для пользователей, зарегистрированных только через Telegram.

#### 3.1.2. Аутентификация через Telegram

- **Описание:** Пользователь может аутентифицироваться в системе, используя свой Telegram-аккаунт.
- **Требования:**
  - Возможность инициировать процесс аутентификации через Telegram (например, через бота или ссылку).
  - Получение хэша от Telegram для верификации подлинности запроса.
  - Проверка хэша для подтверждения личности пользователя.
  - Привязка Telegram ID к существующему пользователю или создание нового пользователя при первой аутентификации через Telegram.
  - Назначение соответствующих доступов пользователям после успешной авторизации.
  - Генерация и выдача JWT-токенов для аутентифицированных пользователей.
  - Обработка ошибок при некорректных данных или неудачных попытках аутентификации.
  - Поддержка пользователей, изначально зарегистрированных через Telegram (из старой базы).

#### 3.1.3. Дополнительная аутентификация для модераторов и администраторов

- **Описание:** Пользователи, которым назначены роли модераторов или администраторов, могут потребовать дополнительной аутентификации через логин и пароль.
- **Требования:**
  - **Доступ к эндпоинту `/api/v1/auth/upgrade`:**
    - Только пользователи с доступом `MANAGE_ACCESSES` (администраторы) могут использовать данный эндпоинт.
  - **Функциональность:**
    - Возможность добавления логина и пароля к существующему пользователю, привязанному только к Telegram ID.
    - Эндпоинт для установки или изменения логина и пароля пользователем с соответствующими правами доступа.
    - Обеспечение проверки наличия логина и пароля при попытке выполнения операций, требующих соответствующих прав.
    - Обработка ошибок при попытке установить логин и пароль для пользователя без необходимых прав или при попытке установить уже существующий логин.
    - Обновление данных пользователя в таблице `users`, добавление значений в поля `login` и `password_hash`.

### 3.2. Управление сессиями

- **Описание:** Обеспечить управление сессиями пользователей для поддержания их состояния авторизации.
- **Требования:**
  - Использование JWT-токенов с определенным сроком действия.
  - Обновление токенов по истечении срока действия (рефреш-токены).
  - Возможность выхода пользователя из системы (аннулирование токенов).
  - Обработка случаев использования истекших или аннулированных токенов.

### 3.3. Привязка Telegram ID к пользователю

- **Описание:** Позволяет пользователям привязать свой Telegram ID к аккаунту для упрощенной аутентификации.
- **Требования:**
  - Эндпоинт для привязки Telegram ID к существующему пользователю.
  - Проверка подлинности пользователя перед привязкой Telegram ID.
  - Обеспечение уникальности Telegram ID (один Telegram ID может быть привязан только к одному пользователю).
  - Возможность отвязки Telegram ID от пользователя при необходимости.
  - Обработка ошибок при попытке привязать уже используемый Telegram ID.

### 3.4. Интеграция с модулем "Доступы"

- **Описание:** Модуль "Авторизация" взаимодействует с модулем "Доступы" для проверки прав доступа пользователей.
- **Требования:**
  - При аутентификации, после подтверждения личности пользователя, система проверяет его доступы.
  - JWT-токены включают информацию о доступах пользователя для упрощения проверки на стороне клиента.
  - Обеспечение актуальности доступов при изменении их в модуле "Доступы".
  - **Ссылка на документ о доступах:** [Техническое задание на разработку модуля "Доступы"](obsidian://open?vault=docs&file=%D0%A0%D0%B5%D0%BB%D0%B8%D0%B7%201%20%E2%80%93%20%D0%A0%D0%B5%D0%B3%D0%B8%D1%81%D1%82%D1%80%D0%B0%D1%86%D0%B8%D1%8F%20%D0%BF%D0%BE%D1%81%D0%B5%D1%89%D0%B5%D0%BD%D0%B8%D0%B9%2F%D0%94%D0%BE%D1%81%D1%82%D1%83%D0%BF%D1%8B%2F%D0%91%D1%8D%D0%BA%D0%B5%D0%BD%D0%B4%20%E2%80%93%20%D0%A2%D0%B5%D1%85%D0%BD%D0%B8%D1%87%D0%B5%D1%81%D0%BA%D0%BE%D0%B5%20%D0%B7%D0%B0%D0%B4%D0%B0%D0%BD%D0%B8%D0%B5).

---

## 4. Нефункциональные требования

### 4.1. Безопасность

- **Аутентификация и авторизация:**
  - Использовать надежные методы аутентификации (например, JWT с секретными ключами).
  - Реализовать систему доступов для контроля доступа (**доступы**).
- **Защита данных:**
  - Шифрование данных при передаче (SSL/TLS).
  - Хранение паролей в зашифрованном виде (например, с использованием bcrypt).
  - Соответствие требованиям законодательства о защите персональных данных (например, GDPR).
- **Защита от атак:**
  - Реализовать защиту от распространенных веб-атак (SQL-инъекции, XSS, CSRF и т.д.).
  - Ограничить количество попыток входа для предотвращения атак грубой силы.
  - Использовать механизмы предотвращения утечек информации через ошибки и сообщения.

### 4.2. Производительность

- **Время отклика:** Не более 2 секунд для основных операций.
- **Нагрузка:** Способность обрабатывать стандартную нагрузку системы с возможностью масштабирования.

### 4.3. Масштабируемость

- **Архитектура:**
  - Модульная архитектура, позволяющая легко добавлять новый функционал.
  - Возможность горизонтального и вертикального масштабирования системы.

### 4.4. Надежность и отказоустойчивость

- **Доступность:** Система должна быть доступна не менее 99.9% времени.
- **Резервное копирование:** Регулярное резервное копирование базы данных.
- **Восстановление после сбоев:** Быстрое восстановление системы в случае непредвиденных сбоев.

### 4.5. Документирование

- **Код и API:**
  - Подробная документация кода для облегчения понимания и поддержки.
  - Документация API (например, с использованием Swagger/OpenAPI).

---

## 5. Требования к данным

### 5.1. Модель данных

#### Таблица `users`

| Поле          | Тип данных | Описание                                                 | Ограничения                                                     |
|---------------|------------|----------------------------------------------------------|-----------------------------------------------------------------|
| user_id       | UUID       | Уникальный идентификатор пользователя                    | Primary Key, Unique, Not Null                                   |
| login         | VARCHAR    | Уникальный логин пользователя                           | Unique, Nullable                                                |
| password_hash | VARCHAR    | Хеш пароля пользователя (для стандартной аутентификации)  | Nullable (используется только при наличии логина и пароля)       |
| created_at    | TIMESTAMP  | Дата и время регистрации пользователя                    | Default: CURRENT_TIMESTAMP                                     |
| updated_at    | TIMESTAMP  | Дата и время последнего обновления данных пользователя   | Default: CURRENT_TIMESTAMP ON UPDATE                           |

- **Примечание:** Таблица `users` содержит информацию о пользователях системы. Поля `login` и `password_hash` являются необязательными и используются только для пользователей, которым назначены роли, требующие стандартной аутентификации (например, администраторы и модераторы). Пользователи, зарегистрированные только через Telegram, могут не иметь значений в этих полях.

#### Таблица `user_telegram`

| Поле        | Тип данных | Описание                                  | Ограничения                                               |
|-------------|------------|-------------------------------------------|-----------------------------------------------------------|
| user_id     | UUID       | Идентификатор пользователя                | Foreign Key (ссылается на `users.user_id`), Primary Key    |
| telegram_id | BIGINT     | Уникальный идентификатор Telegram пользователя | Unique, Not Null                                         |
| linked_at   | TIMESTAMP  | Дата и время привязки Telegram ID         | Default: CURRENT_TIMESTAMP                                |

- **Примечание:** Таблица `user_telegram` содержит связь между пользователями и их Telegram ID. Каждый Telegram ID может быть привязан только к одному пользователю.

### 5.2. Требования к базе данных

- **Производительность:**
  - Оптимизация запросов и использование индексов на часто используемых полях (например, `login`, `telegram_id`).
  - Использование индексов на полях `user_id` в таблицах `user_accesses` и `user_telegram` для ускорения операций аутентификации и управления доступами.
  
- **Целостность данных:**
  - Обеспечение ссылочной целостности между таблицами `users`, `accesses`, `user_accesses` и `user_telegram`.
  - Настройка ограничений на уровне базы данных для предотвращения дублирования записей (например, уникальные ключи на `login` и `telegram_id`).

- **Безопасность:**
  - Ограничение доступа к таблицам `users`, `user_telegram` и `user_accesses` только для сервисов, отвечающих за управление авторизацией и доступами.
  - Использование ролевых схем безопасности базы данных для разделения прав доступа.

---

## 6. Спецификация API

### 6.1. Эндпоинты для аутентификации

#### 6.1.1. Стандартная аутентификация

- **Метод:** POST
- **URL:** `/api/v1/auth/register`
- **Заголовки:**
  - `Content-Type: application/json`
- **Тело запроса:**
  ```json
  {
    "login": "user_login",
    "password": "SecurePassword123"
  }
  ```
- **Ответ:**
  - **201 Created**
  ```json
  {
    "user_id": "uuid_user",
    "login": "user_login",
    "created_at": "2024-04-27T12:34:56Z"
  }
  ```
  - **400 Bad Request** (например, если логин уже зарегистрирован)
  ```json
  {
    "error": "Логин уже используется."
  }
  ```

- **Метод:** POST
- **URL:** `/api/v1/auth/login`
- **Заголовки:**
  - `Content-Type: application/json`
- **Тело запроса:**
  ```json
  {
    "login": "user_login",
    "password": "SecurePassword123"
  }
  ```
- **Ответ:**
  - **200 OK**
  ```json
  {
    "access_token": "jwt_access_token",
    "refresh_token": "jwt_refresh_token",
    "expires_in": 3600
  }
  ```
  - **401 Unauthorized** (например, неверный пароль)
  ```json
  {
    "error": "Неверные учетные данные."
  }
  ```

#### 6.1.2. Аутентификация через Telegram

- **Метод:** POST
- **URL:** `/api/v1/auth/telegram`
- **Заголовки:**
  - `Content-Type: application/json`
- **Тело запроса:**
  ```json
  {
    "hash": "telegram_hash",
    "auth_date": 1614289072,
    "telegram_id": 123456789
  }
  ```
- **Ответ:**
  - **200 OK**
  ```json
  {
    "access_token": "jwt_access_token",
    "refresh_token": "jwt_refresh_token",
    "expires_in": 3600
  }
  ```
  - **400 Bad Request** (например, неверный хэш)
  ```json
  {
    "error": "Некорректные данные для аутентификации через Telegram."
  }
  ```
  - **404 Not Found** (если пользователь не найден и не может быть создан)
  ```json
  {
    "error": "Пользователь не найден и не может быть создан."
  }
  ```

#### 6.1.3. Дополнительная аутентификация для модераторов и администраторов

- **Метод:** POST
- **URL:** `/api/v1/auth/upgrade`
- **Заголовки:**
  - `Authorization: Bearer <access_token>`
  - `Content-Type: application/json`
- **Требования к доступу:** Только пользователи с доступом `MANAGE_ACCESSES` (администраторы) могут использовать данный эндпоинт.
- **Тело запроса:**
  ```json
  {
    "user_id": "uuid_user",
    "login": "new_admin_login",
    "password": "NewSecurePassword123"
  }
  ```
- **Ответ:**
  - **200 OK**
  ```json
  {
    "message": "Логин и пароль успешно установлены."
  }
  ```
  - **400 Bad Request** (если логин уже используется)
  ```json
  {
    "error": "Логин уже используется."
  }
  ```
  **400 Bad Request** (если аккаунт уже имеет логин)
  ```json
  {
    "error": "Аккаунт уже имеет логин."
  }
  ```
  - **403 Forbidden** (если пользователь не имеет прав для выполнения этого действия)
  ```json
  {
    "error": "Недостаточно прав для выполнения этого запроса."
  }
  ```
  - **404 Not Found** (если пользователь не найден)
  ```json
  {
    "error": "Пользователь не найден."
  }
  ```

### 6.2. Эндпоинты для управления сессиями

#### 6.2.1. Получение текущих доступов пользователя

- **Метод:** GET
- **URL:** `/api/v1/users/{user_id}/accesses`
- **Заголовки:**
  - `Authorization: Bearer <access_token>`
- **Требования к доступу:** Пользователь должен обладать доступом `MANAGE_ACCESSES`.
- **Ответ:**
  - **200 OK**
  ```json
  {
    "user_id": "uuid_user",
    "accesses": ["CREATE_EVENT", "DELETE_USER"]
  }
  ```
  - **404 Not Found** (если пользователь не найден)
  ```json
  {
    "error": "Пользователь не найден."
  }
  ```
  - **403 Forbidden** (если текущий пользователь не имеет права просматривать доступы других пользователей)
  ```json
  {
    "error": "Недостаточно прав для выполнения этого запроса."
  }
  ```

### 6.3. Аутентификация и авторизация

- **Описание:** Все эндпоинты модуля **"Авторизация"** защищены механизмами аутентификации и авторизации. Доступ к эндпоинтам осуществляется только пользователям с соответствующими доступами, определяемыми модулем **"Доступы"** (например, `MANAGE_ACCESSES` для управления доступами и просмотра информации о пользователях).

---

## 7. Архитектурные решения

### 7.1. Сервисная архитектура

- **Модульность:** Модуль **"Авторизация"** разработан как отдельный сервис, который взаимодействует с другими модулями через API. Это обеспечивает независимость и облегчает масштабирование.
- **Стандарты:** Соблюдение RESTful стандартов при разработке API. Использование стандартных методов HTTP (GET, POST, DELETE).

### 7.2. Подготовка к будущим функционалам

- **Многоуровневая система доступов:**
  - Предусмотреть возможность добавления дополнительных уровней доступов и гибкой настройки доступа.
  - Обеспечить гибкость в управлении доступами через административный интерфейс или конфигурационные файлы.
- **Методы аутентификации:**
  - Возможность добавления альтернативных методов аутентификации (например, OAuth, SSO) без значительных изменений в архитектуре.
- **Интеграция с новым флоу авторизации через Telegram:**
  - Обеспечить, чтобы назначение доступов через Telegram соответствовало общей системе управления доступами.
  - Интегрировать этот флоу с существующей системой доступов для контроля доступа.

---

## 8. Требования к безопасности

- **Аутентификация и авторизация:**
  - Реализовать механизмы проверки прав доступа для каждого эндпоинта.
  - Ограничить доступ к эндпоинтам **"Авторизация"** только для пользователей с соответствующими доступами (например, `MANAGE_ACCESSES`).
- **Шифрование данных:**
  - Обеспечить шифрование всех передаваемых данных с использованием SSL/TLS.
  - Хранить чувствительные данные (например, пароли) в зашифрованном виде с использованием современных алгоритмов хеширования (например, bcrypt).
- **Защита от атак:**
  - Реализовать защиту от распространенных веб-атак (SQL-инъекции, XSS, CSRF и т.д.).
  - Ограничить количество попыток выполнения операций для предотвращения атак грубой силы.
  - Использовать механизмы предотвращения утечек информации через ошибки и сообщения.
- **Логирование и аудит:**
  - Вести журналы всех операций по аутентификации и управлению доступами.
  - Обеспечить защиту журналов от несанкционированного доступа и изменений.

---

## 9. Требования к тестированию

### 9.1. Функциональное тестирование

- **Тестирование регистрации и аутентификации:**
  - Проверка успешной регистрации нового пользователя.
  - Проверка аутентификации с правильными и неправильными учетными данными.
- **Тестирование аутентификации через Telegram:**
  - Проверка успешной аутентификации через Telegram.
  - Проверка обработки некорректных данных при аутентификации через Telegram.
- **Тестирование привязки Telegram ID:**
  - Проверка успешной привязки Telegram ID к пользователю.
  - Проверка отказа при попытке привязать уже используемый Telegram ID.
- **Тестирование управления доступами:**
  - Проверка получения текущих доступов пользователя.
  - Проверка ограничений доступа для пользователей без необходимых прав.
- **Тестирование управления сессиями:**
  - Проверка обновления и аннулирования токенов.
  - Проверка доступа с использованием истекших или аннулированных токенов.
- **Тестирование дополнительной аутентификации для модераторов и администраторов:**
  - Проверка установки и изменения логина и пароля.
  - Проверка доступа к защищенным эндпоинтам после установки логина и пароля.

### 9.2. Нагрузочное тестирование

- **Производительность:**
  - Проверка времени отклика системы под стандартной и повышенной нагрузкой.
  - Оценка устойчивости системы к пиковым нагрузкам.
- **Масштабируемость:**
  - Проверка работы системы при увеличении количества пользователей и запросов.
  - Проверка производительности при увеличении объема данных (например, большое количество привязок Telegram ID).

### 9.3. Безопасностное тестирование

- **Тестирование на уязвимости:**
  - SQL-инъекции, XSS, CSRF и другие распространенные веб-атаки.
- **Проверка механизмов аутентификации и авторизации:**
  - Убедиться, что только авторизованные пользователи с соответствующими доступами имеют доступ к эндпоинтам.
- **Тестирование шифрования данных:**
  - Проверка безопасности передачи и хранения данных.
- **Тестирование защиты от атак грубой силы:**
  - Проверка ограничения количества попыток выполнения операций.

---

## 10. План реализации

### 10.1. Этапы проекта

1. **Проектирование:**
   - Разработка модели данных для управления аутентификацией и привязкой Telegram ID.
   - Определение структуры API и схемы взаимодействия с другими модулями.
2. **Разработка:**
   - Реализация эндпоинтов для стандартной аутентификации.
   - Реализация эндпоинтов для аутентификации через Telegram.
   - Реализация функционала привязки и отвязки Telegram ID.
   - Реализация функционала дополнительной аутентификации для модераторов и администраторов.
   - Интеграция с модулем **"Доступы"** для проверки прав доступа.
   - Обеспечение безопасности и защиты данных.
3. **Тестирование:**
   - Функциональное тестирование всех компонентов модуля.
   - Нагрузочное тестирование для оценки производительности.
   - Безопасностное тестирование для выявления и устранения уязвимостей.
4. **Документирование:**
   - Подготовка технической документации для разработчиков.
   - Документирование API (например, с использованием Swagger/OpenAPI).
5. **Внедрение:**
   - Развертывание модуля на сервере.
   - Проведение необходимых настроек и интеграция с другими модулями.
   - Проведение обучающих сессий для команды поддержки.

### 10.2. Сроки и ресурсы

- **Предварительные сроки:**
  - Общая продолжительность разработки модуля **"Авторизация"**: 3-4 недели.
- **Команда проекта:**
  - **Backend-разработчики:** 2 человека.
  - **Тестировщики:** 1-2 человека.
  - **Бизнес-аналитик:** 1 человек (при необходимости для уточнения требований).
  - **Специалист по безопасности:** 1 человек (при необходимости для проведения безопасностного тестирования).

---

## 11. Дополнительные замечания

- **Качество кода:** Следование принципам чистого кода и код-стайлу команды для облегчения поддержки и дальнейшего развития модуля.
- **Обратная связь:** Регулярные встречи команды для обсуждения прогресса, возникающих вопросов и потенциальных улучшений.
- **Риски:**
  - Возможные изменения требований со стороны стейкхолдеров.
  - Задержки в интеграции с другими модулями системы.
  - Уязвимости безопасности, обнаруженные в процессе тестирования.
- **Взаимодействие с другими модулями:**
  - Обеспечить стабильное и безопасное взаимодействие с модулями **"Доступы"**, **"Пользователи"**, **"Админ. приложение"**, **"Сканнер"** и **"MiniApp"**.
  - Предусмотреть механизм передачи информации о доступах пользователей для обеспечения корректной авторизации в других модулях.