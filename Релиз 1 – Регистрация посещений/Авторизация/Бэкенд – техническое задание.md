- [1. Введение](#1-%D0%92%D0%B2%D0%B5%D0%B4%D0%B5%D0%BD%D0%B8%D0%B5)
	- [1.1. Цель документа](#11-%D0%A6%D0%B5%D0%BB%D1%8C-%D0%B4%D0%BE%D0%BA%D1%83%D0%BC%D0%B5%D0%BD%D1%82%D0%B0)
	- [1.2. Область применения](#12-%D0%9E%D0%B1%D0%BB%D0%B0%D1%81%D1%82%D1%8C-%D0%BF%D1%80%D0%B8%D0%BC%D0%B5%D0%BD%D0%B5%D0%BD%D0%B8%D1%8F)
- [2. Общее описание](#2-%D0%9E%D0%B1%D1%89%D0%B5%D0%B5-%D0%BE%D0%BF%D0%B8%D1%81%D0%B0%D0%BD%D0%B8%D0%B5)
	- [2.1. Перспектива продукта](#21-%D0%9F%D0%B5%D1%80%D1%81%D0%BF%D0%B5%D0%BA%D1%82%D0%B8%D0%B2%D0%B0-%D0%BF%D1%80%D0%BE%D0%B4%D1%83%D0%BA%D1%82%D0%B0)
	- [2.2. Основные функции модуля "Авторизация"](#22-%D0%9E%D1%81%D0%BD%D0%BE%D0%B2%D0%BD%D1%8B%D0%B5-%D1%84%D1%83%D0%BD%D0%BA%D1%86%D0%B8%D0%B8-%D0%BC%D0%BE%D0%B4%D1%83%D0%BB%D1%8F-%D0%90%D0%B2%D1%82%D0%BE%D1%80%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D1%8F)
	- [2.3. Управление доступами](#23-%D0%A3%D0%BF%D1%80%D0%B0%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5-%D0%B4%D0%BE%D1%81%D1%82%D1%83%D0%BF%D0%B0%D0%BC%D0%B8)
- [3. Функциональные требования](#3-%D0%A4%D1%83%D0%BD%D0%BA%D1%86%D0%B8%D0%BE%D0%BD%D0%B0%D0%BB%D1%8C%D0%BD%D1%8B%D0%B5-%D1%82%D1%80%D0%B5%D0%B1%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F)
	- [3.1. Аутентификация пользователей](#31-%D0%90%D1%83%D1%82%D0%B5%D0%BD%D1%82%D0%B8%D1%84%D0%B8%D0%BA%D0%B0%D1%86%D0%B8%D1%8F-%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D0%BE%D0%B2%D0%B0%D1%82%D0%B5%D0%BB%D0%B5%D0%B9)
		- [3.1.1. Аутентификация через Telegram](#311-%D0%90%D1%83%D1%82%D0%B5%D0%BD%D1%82%D0%B8%D1%84%D0%B8%D0%BA%D0%B0%D1%86%D0%B8%D1%8F-%D1%87%D0%B5%D1%80%D0%B5%D0%B7-telegram)
		- [3.1.2. Стандартная аутентификация](#312-%D0%A1%D1%82%D0%B0%D0%BD%D0%B4%D0%B0%D1%80%D1%82%D0%BD%D0%B0%D1%8F-%D0%B0%D1%83%D1%82%D0%B5%D0%BD%D1%82%D0%B8%D1%84%D0%B8%D0%BA%D0%B0%D1%86%D0%B8%D1%8F)
		- [3.1.3. Добавление логина и пароля для существующего пользователя](#313-%D0%94%D0%BE%D0%B1%D0%B0%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5-%D0%BB%D0%BE%D0%B3%D0%B8%D0%BD%D0%B0-%D0%B8-%D0%BF%D0%B0%D1%80%D0%BE%D0%BB%D1%8F-%D0%B4%D0%BB%D1%8F-%D1%81%D1%83%D1%89%D0%B5%D1%81%D1%82%D0%B2%D1%83%D1%8E%D1%89%D0%B5%D0%B3%D0%BE-%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D0%BE%D0%B2%D0%B0%D1%82%D0%B5%D0%BB%D1%8F)
	- [3.2. Управление сессиями](#32-%D0%A3%D0%BF%D1%80%D0%B0%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5-%D1%81%D0%B5%D1%81%D1%81%D0%B8%D1%8F%D0%BC%D0%B8)
	- [3.3. Интеграция с модулем "Пользователи"](#33-%D0%98%D0%BD%D1%82%D0%B5%D0%B3%D1%80%D0%B0%D1%86%D0%B8%D1%8F-%D1%81-%D0%BC%D0%BE%D0%B4%D1%83%D0%BB%D0%B5%D0%BC-%D0%9F%D0%BE%D0%BB%D1%8C%D0%B7%D0%BE%D0%B2%D0%B0%D1%82%D0%B5%D0%BB%D0%B8)
	- [3.4. Интеграция с модулем "Доступы"](#34-%D0%98%D0%BD%D1%82%D0%B5%D0%B3%D1%80%D0%B0%D1%86%D0%B8%D1%8F-%D1%81-%D0%BC%D0%BE%D0%B4%D1%83%D0%BB%D0%B5%D0%BC-%D0%94%D0%BE%D1%81%D1%82%D1%83%D0%BF%D1%8B)
- [4. Нефункциональные требования](#4-%D0%9D%D0%B5%D1%84%D1%83%D0%BD%D0%BA%D1%86%D0%B8%D0%BE%D0%BD%D0%B0%D0%BB%D1%8C%D0%BD%D1%8B%D0%B5-%D1%82%D1%80%D0%B5%D0%B1%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F)
	- [4.1. Безопасность](#41-%D0%91%D0%B5%D0%B7%D0%BE%D0%BF%D0%B0%D1%81%D0%BD%D0%BE%D1%81%D1%82%D1%8C)
	- [4.2. Производительность](#42-%D0%9F%D1%80%D0%BE%D0%B8%D0%B7%D0%B2%D0%BE%D0%B4%D0%B8%D1%82%D0%B5%D0%BB%D1%8C%D0%BD%D0%BE%D1%81%D1%82%D1%8C)
	- [4.3. Масштабируемость](#43-%D0%9C%D0%B0%D1%81%D1%88%D1%82%D0%B0%D0%B1%D0%B8%D1%80%D1%83%D0%B5%D0%BC%D0%BE%D1%81%D1%82%D1%8C)
	- [4.4. Надежность и отказоустойчивость](#44-%D0%9D%D0%B0%D0%B4%D0%B5%D0%B6%D0%BD%D0%BE%D1%81%D1%82%D1%8C-%D0%B8-%D0%BE%D1%82%D0%BA%D0%B0%D0%B7%D0%BE%D1%83%D1%81%D1%82%D0%BE%D0%B9%D1%87%D0%B8%D0%B2%D0%BE%D1%81%D1%82%D1%8C)
	- [4.5. Документирование](#45-%D0%94%D0%BE%D0%BA%D1%83%D0%BC%D0%B5%D0%BD%D1%82%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5)
- [5. Требования к данным](#5-%D0%A2%D1%80%D0%B5%D0%B1%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F-%D0%BA-%D0%B4%D0%B0%D0%BD%D0%BD%D1%8B%D0%BC)
	- [5.1. Модель данных](#51-%D0%9C%D0%BE%D0%B4%D0%B5%D0%BB%D1%8C-%D0%B4%D0%B0%D0%BD%D0%BD%D1%8B%D1%85)
		- [Таблица `users`](#%D0%A2%D0%B0%D0%B1%D0%BB%D0%B8%D1%86%D0%B0-users)
		- [Таблица `user_telegram`](#%D0%A2%D0%B0%D0%B1%D0%BB%D0%B8%D1%86%D0%B0-user_telegram)
	- [5.2. Требования к базе данных](#52-%D0%A2%D1%80%D0%B5%D0%B1%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F-%D0%BA-%D0%B1%D0%B0%D0%B7%D0%B5-%D0%B4%D0%B0%D0%BD%D0%BD%D1%8B%D1%85)
- [6. Спецификация API](#6-%D0%A1%D0%BF%D0%B5%D1%86%D0%B8%D1%84%D0%B8%D0%BA%D0%B0%D1%86%D0%B8%D1%8F-api)
	- [6.1. Эндпоинты для аутентификации](#61-%D0%AD%D0%BD%D0%B4%D0%BF%D0%BE%D0%B8%D0%BD%D1%82%D1%8B-%D0%B4%D0%BB%D1%8F-%D0%B0%D1%83%D1%82%D0%B5%D0%BD%D1%82%D0%B8%D1%84%D0%B8%D0%BA%D0%B0%D1%86%D0%B8%D0%B8)
		- [6.1.1. Аутентификация через Telegram](#611-%D0%90%D1%83%D1%82%D0%B5%D0%BD%D1%82%D0%B8%D1%84%D0%B8%D0%BA%D0%B0%D1%86%D0%B8%D1%8F-%D1%87%D0%B5%D1%80%D0%B5%D0%B7-telegram)
		- [6.1.2. Стандартная аутентификация](#612-%D0%A1%D1%82%D0%B0%D0%BD%D0%B4%D0%B0%D1%80%D1%82%D0%BD%D0%B0%D1%8F-%D0%B0%D1%83%D1%82%D0%B5%D0%BD%D1%82%D0%B8%D1%84%D0%B8%D0%BA%D0%B0%D1%86%D0%B8%D1%8F)
		- [6.1.3. Добавление логина и пароля для существующего пользователя](#613-%D0%94%D0%BE%D0%B1%D0%B0%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5-%D0%BB%D0%BE%D0%B3%D0%B8%D0%BD%D0%B0-%D0%B8-%D0%BF%D0%B0%D1%80%D0%BE%D0%BB%D1%8F-%D0%B4%D0%BB%D1%8F-%D1%81%D1%83%D1%89%D0%B5%D1%81%D1%82%D0%B2%D1%83%D1%8E%D1%89%D0%B5%D0%B3%D0%BE-%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D0%BE%D0%B2%D0%B0%D1%82%D0%B5%D0%BB%D1%8F)
	- [6.2. Эндпоинты для управления сессиями](#62-%D0%AD%D0%BD%D0%B4%D0%BF%D0%BE%D0%B8%D0%BD%D1%82%D1%8B-%D0%B4%D0%BB%D1%8F-%D1%83%D0%BF%D1%80%D0%B0%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D1%8F-%D1%81%D0%B5%D1%81%D1%81%D0%B8%D1%8F%D0%BC%D0%B8)
		- [6.2.1. Выход из системы](#621-%D0%92%D1%8B%D1%85%D0%BE%D0%B4-%D0%B8%D0%B7-%D1%81%D0%B8%D1%81%D1%82%D0%B5%D0%BC%D1%8B)
- [7. Архитектурные решения](#7-%D0%90%D1%80%D1%85%D0%B8%D1%82%D0%B5%D0%BA%D1%82%D1%83%D1%80%D0%BD%D1%8B%D0%B5-%D1%80%D0%B5%D1%88%D0%B5%D0%BD%D0%B8%D1%8F)
	- [7.1. Модульная архитектура](#71-%D0%9C%D0%BE%D0%B4%D1%83%D0%BB%D1%8C%D0%BD%D0%B0%D1%8F-%D0%B0%D1%80%D1%85%D0%B8%D1%82%D0%B5%D0%BA%D1%82%D1%83%D1%80%D0%B0)
	- [7.2. Разделение ответственности](#72-%D0%A0%D0%B0%D0%B7%D0%B4%D0%B5%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5-%D0%BE%D1%82%D0%B2%D0%B5%D1%82%D1%81%D1%82%D0%B2%D0%B5%D0%BD%D0%BD%D0%BE%D1%81%D1%82%D0%B8)
	- [7.3. Взаимодействие между модулями](#73-%D0%92%D0%B7%D0%B0%D0%B8%D0%BC%D0%BE%D0%B4%D0%B5%D0%B9%D1%81%D1%82%D0%B2%D0%B8%D0%B5-%D0%BC%D0%B5%D0%B6%D0%B4%D1%83-%D0%BC%D0%BE%D0%B4%D1%83%D0%BB%D1%8F%D0%BC%D0%B8)
- [8. Требования к безопасности](#8-%D0%A2%D1%80%D0%B5%D0%B1%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F-%D0%BA-%D0%B1%D0%B5%D0%B7%D0%BE%D0%BF%D0%B0%D1%81%D0%BD%D0%BE%D1%81%D1%82%D0%B8)
- [9. Требования к тестированию](#9-%D0%A2%D1%80%D0%B5%D0%B1%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F-%D0%BA-%D1%82%D0%B5%D1%81%D1%82%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D1%8E)
	- [9.1. Функциональное тестирование](#91-%D0%A4%D1%83%D0%BD%D0%BA%D1%86%D0%B8%D0%BE%D0%BD%D0%B0%D0%BB%D1%8C%D0%BD%D0%BE%D0%B5-%D1%82%D0%B5%D1%81%D1%82%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5)
	- [9.2. Нагрузочное тестирование](#92-%D0%9D%D0%B0%D0%B3%D1%80%D1%83%D0%B7%D0%BE%D1%87%D0%BD%D0%BE%D0%B5-%D1%82%D0%B5%D1%81%D1%82%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5)
	- [9.3. Безопасностное тестирование](#93-%D0%91%D0%B5%D0%B7%D0%BE%D0%BF%D0%B0%D1%81%D0%BD%D0%BE%D1%81%D1%82%D0%BD%D0%BE%D0%B5-%D1%82%D0%B5%D1%81%D1%82%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5)
- [10. План реализации](#10-%D0%9F%D0%BB%D0%B0%D0%BD-%D1%80%D0%B5%D0%B0%D0%BB%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D0%B8)
	- [10.1. Этапы проекта](#101-%D0%AD%D1%82%D0%B0%D0%BF%D1%8B-%D0%BF%D1%80%D0%BE%D0%B5%D0%BA%D1%82%D0%B0)
	- [10.2. Сроки и ресурсы](#102-%D0%A1%D1%80%D0%BE%D0%BA%D0%B8-%D0%B8-%D1%80%D0%B5%D1%81%D1%83%D1%80%D1%81%D1%8B)
- [11. Дополнительные замечания](#11-%D0%94%D0%BE%D0%BF%D0%BE%D0%BB%D0%BD%D0%B8%D1%82%D0%B5%D0%BB%D1%8C%D0%BD%D1%8B%D0%B5-%D0%B7%D0%B0%D0%BC%D0%B5%D1%87%D0%B0%D0%BD%D0%B8%D1%8F)

## 1. Введение

### 1.1. Цель документа

Цель данного документа — определить требования и спецификации для разработки бэкенд-функционала модуля **"Авторизация"** в рамках первого релиза цифрового сервиса по автоматизации системы регистрации посещений мероприятий в университете.

### 1.2. Область применения

Документ предназначен для команды разработчиков бэкенда и тестировщиков, участвующих в реализации модуля **"Авторизация"**. Он описывает функциональные и нефункциональные требования, модели данных, спецификации API и другие аспекты, необходимые для разработки и интеграции модуля с остальной системой.

---

## 2. Общее описание

### 2.1. Перспектива продукта

Модуль **"Авторизация"** обеспечивает механизмы аутентификации и авторизации пользователей системы. Он поддерживает аутентификацию через внешние сервисы, такие как Telegram, а также предоставляет возможность добавления логина и пароля для существующих пользователей через специальный эндпоинт. Модуль интегрируется с модулями **"Пользователи"** и **"Доступы"**, обеспечивая гибкую и масштабируемую систему управления доступом пользователей к различным функциям системы.

### 2.2. Основные функции модуля "Авторизация"

- **Аутентификация пользователей** через Telegram.
- **Стандартная аутентификация** с использованием логина и пароля.
- **Добавление логина и пароля** для существующих пользователей через эндпоинт `/upgrade`.
- **Проверка статуса заполнения профиля пользователя** с использованием поля `profile_completed`, получаемого из модуля **"Пользователи"**.
- **Управление сессиями пользователей**.
- **Интеграция с модулями "Пользователи" и "Доступы"**.
- **Обеспечение безопасности данных** и защита от несанкционированного доступа.

### 2.3. Управление доступами

Система оперирует исключительно доступами (permissions), которые определяют права пользователей на выполнение определенных действий или доступ к конкретным ресурсам. Контроль доступа осуществляется на основе этих доступов, а не ролей.

---

## 3. Функциональные требования

### 3.1. Аутентификация пользователей

#### 3.1.1. Аутентификация через Telegram

- **Описание:** Пользователь может аутентифицироваться в системе, используя свой Telegram-аккаунт.
- **Требования:**
  - Возможность инициировать процесс аутентификации через Telegram (например, через Telegram Login Widget).
  - Получение данных от Telegram для верификации подлинности запроса.
  - Проверка полученных данных для подтверждения личности пользователя.
  - Привязка Telegram ID к существующему пользователю или создание нового пользователя при первой аутентификации через Telegram.
  - Генерация и выдача JWT-токена для аутентифицированного пользователя.
  - **Получение статуса `profile_completed`:**
    - После успешной аутентификации модуль "Авторизация" обращается к модулю "Пользователи" для получения значения `profile_completed`.
    - Включить значение `profile_completed` в ответ API.
  - Обработка ошибок при некорректных данных или неудачных попытках аутентификации.

#### 3.1.2. Стандартная аутентификация

- **Описание:** Пользователи, имеющие логин и пароль, могут аутентифицироваться в системе, используя эти учетные данные.
- **Требования:**
  - Пользователь вводит логин и пароль для входа.
  - Проверка соответствия введенных данных с сохраненными в системе.
  - Генерация и выдача JWT-токена для аутентифицированного пользователя.
  - **Получение статуса `profile_completed`:**
    - После успешной аутентификации модуль "Авторизация" обращается к модулю "Пользователи" для получения значения `profile_completed`.
    - Включить значение `profile_completed` в ответ API.
  - Обработка ошибок при неверных учетных данных.

#### 3.1.3. Добавление логина и пароля для существующего пользователя

- **Описание:** Пользователи с соответствующими доступами могут добавить логин и пароль к существующему аккаунту через эндпоинт `/upgrade`.
- **Требования:**
  - **Доступ к эндпоинту `/api/v1/auth/upgrade`:**
    - Требуется доступ `MANAGE_ACCESSES`.
  - **Функциональность:**
    - Возможность добавления или изменения логина и пароля для существующего пользователя.
    - Проверка уникальности логина при добавлении или изменении.
    - Обновление данных пользователя в системе.
    - Обработка ошибок при попытке установить уже существующий логин или при отсутствии необходимых доступов.

### 3.2. Управление сессиями

- **Описание:** Обеспечить управление сессиями пользователей для поддержания их состояния авторизации.
- **Требования:**
  - Использование JWT-токенов с определенным сроком действия.
  - Возможность выхода пользователя из системы (аннулирование токенов).
  - Обработка случаев использования истекших или аннулированных токенов.

### 3.3. Интеграция с модулем "Пользователи"

- **Описание:** Модуль "Авторизация" взаимодействует с модулем "Пользователи" для получения информации о пользователе, включая статус `profile_completed`.
- **Требования:**
  - Использование общего `user_id` для идентификации пользователей между модулями.
  - После успешной аутентификации модуль "Авторизация" запрашивает у модуля "Пользователи" значение `profile_completed`.
  - Обеспечение безопасности и целостности данных при межмодульном взаимодействии.

### 3.4. Интеграция с модулем "Доступы"

- **Описание:** Модуль "Авторизация" взаимодействует с модулем "Доступы" для проверки прав доступа пользователей.
- **Требования:**
  - При аутентификации система проверяет доступы пользователя.
  - JWT-токены включают информацию о доступах пользователя.
  - Обеспечение актуальности доступов при их изменении.

---

## 4. Нефункциональные требования

### 4.1. Безопасность

- **Аутентификация и авторизация:**
  - Использование надежных методов аутентификации (например, JWT с секретными ключами).
  - Реализация системы доступа, основанной на доступах (permissions).
- **Защита данных:**
  - Шифрование данных при передаче (SSL/TLS).
  - Хранение паролей в зашифрованном виде (например, с использованием bcrypt).
- **Защита от атак:**
  - Реализация защиты от распространенных веб-атак (SQL-инъекции, XSS, CSRF и т.д.).
  - Ограничение количества попыток входа для предотвращения атак грубой силы.

### 4.2. Производительность

- **Время отклика:** Не более 2 секунд для основных операций.

### 4.3. Масштабируемость

- **Архитектура:**
  - Модульная архитектура, позволяющая легко разделить функциональность на отдельные сервисы в будущем.
  - Четкое разделение модулей с использованием интерфейсов для взаимодействия.

### 4.4. Надежность и отказоустойчивость

- **Доступность:** Система должна быть доступна не менее 99.9% времени.

### 4.5. Документирование

- **Код и API:**
  - Подробная документация кода и API.
  - Использование Swagger/OpenAPI для автоматизации документирования API.

---

## 5. Требования к данным

### 5.1. Модель данных

#### Таблица `users`

| Поле          | Тип данных | Описание                                    | Ограничения                                    |
|---------------|------------|---------------------------------------------|------------------------------------------------|
| user_id       | UUID       | Уникальный идентификатор пользователя       | PRIMARY KEY, NOT NULL                          |
| username      | VARCHAR    | Уникальный логин пользователя               | UNIQUE, NULLABLE                               |
| password_hash | VARCHAR    | Хеш пароля пользователя                     | NULLABLE                                       |
| created_at    | TIMESTAMP  | Дата и время регистрации пользователя       | DEFAULT CURRENT_TIMESTAMP, NOT NULL            |
| updated_at    | TIMESTAMP  | Дата и время последнего обновления          | DEFAULT CURRENT_TIMESTAMP ON UPDATE, NOT NULL  |

- **Примечание:** Поле `profile_completed` в модуле "Авторизация" отсутствует. Информация о статусе профиля хранится в модуле "Пользователи".

#### Таблица `user_telegram`

| Поле        | Тип данных | Описание                                       | Ограничения                                     |
|-------------|------------|------------------------------------------------|-------------------------------------------------|
| user_id     | UUID       | Идентификатор пользователя                     | PRIMARY KEY, FOREIGN KEY (`users.user_id`), NOT NULL |
| telegram_id | BIGINT     | Уникальный идентификатор пользователя Telegram | UNIQUE, NOT NULL                                |
| linked_at   | TIMESTAMP  | Дата и время привязки Telegram ID              | DEFAULT CURRENT_TIMESTAMP, NOT NULL             |

### 5.2. Требования к базе данных

- **Производительность:**
  - Использование индексов на полях `username`, `telegram_id`, `user_id`.
- **Целостность данных:**
  - Обеспечение ссылочной целостности между таблицами.
- **Безопасность:**
  - Ограничение доступа к таблицам только для необходимых сервисов.

---

## 6. Спецификация API

### 6.1. Эндпоинты для аутентификации

#### 6.1.1. Аутентификация через Telegram

- **Метод:** `POST`
- **URL:** `/api/v1/auth/telegram`
- **Заголовки:**
  - `Content-Type: application/json`
- **Тело запроса:**
  ```json
  {
    "hash": "telegram_hash",
    "auth_date": 1614289072,
    "telegram_id": 123456789
    // Дополнительные поля, полученные от Telegram
  }
  ```
- **Действия:**
  - Верификация данных, полученных от Telegram.
  - Поиск пользователя по `telegram_id` в таблице `user_telegram`.
    - Если пользователь найден:
      - Получить `user_id` и аутентифицировать пользователя.
    - Если пользователь не найден:
      - Создать нового пользователя в модуле "Пользователи" и связать его с `telegram_id`.
  - Получить `profile_completed` из модуля "Пользователи".
- **Ответ:**
  - **200 OK**
    ```json
    {
      "access_token": "jwt_access_token",
      "expires_in": 3600,
      "profile_completed": false
    }
    ```
  - **400 Bad Request**
    ```json
    {
      "error": "Некорректные данные для аутентификации через Telegram."
    }
    ```

#### 6.1.2. Стандартная аутентификация

- **Метод:** `POST`
- **URL:** `/api/v1/auth/login`
- **Заголовки:**
  - `Content-Type: application/json`
- **Тело запроса:**
  ```json
  {
    "username": "exampleUser",
    "password": "examplePassword"
  }
  ```
- **Действия:**
  - Проверка наличия пользователя с указанным `username`.
  - Верификация `password` с использованием `password_hash`.
  - Получение `profile_completed` из модуля "Пользователи".
- **Ответ:**
  - **200 OK**
    ```json
    {
      "access_token": "jwt_access_token",
      "expires_in": 3600,
      "profile_completed": true
    }
    ```
  - **401 Unauthorized**
    ```json
    {
      "error": "Неверные учетные данные."
    }
    ```

#### 6.1.3. Добавление логина и пароля для существующего пользователя

- **Метод:** `POST`
- **URL:** `/api/v1/auth/upgrade`
- **Заголовки:**
  - `Authorization: Bearer <access_token>`
  - `Content-Type: application/json`
- **Требуемый доступ:** `MANAGE_ACCESSES`
- **Тело запроса:**
  ```json
  {
    "user_id": "uuid_user",
    "username": "new_login",
    "password": "NewSecurePassword123"
  }
  ```
- **Действия:**
  - Проверка наличия доступа `MANAGE_ACCESSES`.
  - Проверка уникальности `username`.
  - Обновление данных пользователя в таблице `users`.
- **Ответ:**
  - **200 OK**
    ```json
    {
      "status": "success"
    }
    ```
  - **400 Bad Request**
    ```json
    {
      "error": "Логин уже используется."
    }
    ```
  - **403 Forbidden**
    ```json
    {
      "error": "Недостаточно прав для выполнения операции."
    }
    ```

### 6.2. Эндпоинты для управления сессиями

#### 6.2.1. Выход из системы

- **Метод:** `POST`
- **URL:** `/api/v1/auth/logout`
- **Заголовки:**
  - `Authorization: Bearer <access_token>`
- **Действия:**
  - Аннулирование текущего JWT-токена.
- **Ответ:**
  - **200 OK**
    ```json
    {
      "status": "logged_out"
    }
    ```
  - **401 Unauthorized**
    ```json
    {
      "error": "Необходима авторизация."
    }
    ```

---

## 7. Архитектурные решения

### 7.1. Модульная архитектура

- **Модульность:** Модуль "Авторизация" реализован как отдельный модуль в рамках монолитного приложения, с четко определенными интерфейсами для взаимодействия с другими модулями.
- **Интеграция:** Взаимодействие с модулями "Пользователи" и "Доступы" осуществляется через внутренние сервисные интерфейсы или API, что позволяет в будущем легко вынести модули в отдельные сервисы.

### 7.2. Разделение ответственности

- **Модуль "Авторизация":** Отвечает за аутентификацию и авторизацию пользователей, хранение учетных данных.
- **Модуль "Пользователи":** Отвечает за хранение и управление профилями пользователей, включая `profile_completed`.
- **Модуль "Доступы":** Отвечает за управление доступами (permissions) пользователей.

### 7.3. Взаимодействие между модулями

- **Получение `profile_completed`:**
  - После успешной аутентификации модуль "Авторизация" обращается к модулю "Пользователи" для получения значения `profile_completed` через внутренний сервис или API.
- **Обмен данными:**
  - Используются DTO (Data Transfer Objects) для передачи данных между модулями.
- **Изоляция данных:**
  - Каждый модуль управляет своими данными и предоставляет только необходимые интерфейсы для доступа к ним.

---

## 8. Требования к безопасности

- **Контроль доступа:**
  - Реализация механизма контроля доступа на основе доступов (permissions).
- **Валидация данных:**
  - Проверка входных данных на корректность и безопасность.
- **Шифрование:**
  - Использование SSL/TLS для всех сетевых взаимодействий.
  - Хранение паролей с использованием алгоритма bcrypt или аналогичного.
- **Защита от атак:**
  - Предотвращение SQL-инъекций, XSS, CSRF и других распространенных атак.
- **Логирование и аудит:**
  - Запись действий пользователей для последующего анализа и аудита.
  - Обеспечение безопасности логов и их защиту от несанкционированного доступа.

---

## 9. Требования к тестированию

### 9.1. Функциональное тестирование

- **Аутентификация через Telegram:**
  - Успешная аутентификация.
  - Обработка ошибок при неверных данных.
- **Стандартная аутентификация:**
  - Успешный вход с корректными учетными данными.
  - Обработка ошибок при неверных учетных данных.
- **Добавление логина и пароля:**
  - Проверка возможности добавления логина и пароля для существующего пользователя.
  - Проверка уникальности логина.
  - Обработка ошибок при недостатке доступов.
- **Получение `profile_completed`:**
  - Проверка корректного получения статуса `profile_completed` из модуля "Пользователи".

### 9.2. Нагрузочное тестирование

- **Производительность под нагрузкой:**
  - Оценка времени отклика при большом количестве одновременных запросов.
  - Тестирование устойчивости системы при пиковых нагрузках.

### 9.3. Безопасностное тестирование

- **Проверка на уязвимости:**
  - Тестирование на наличие SQL-инъекций, XSS, CSRF и других атак.
- **Тестирование механизма аутентификации и авторизации:**
  - Проверка надежности хранения и проверки учетных данных.
  - Проверка механизма контроля доступа на основе доступов.

---

## 10. План реализации

### 10.1. Этапы проекта

1. **Проектирование:**
   - Разработка модели данных с учетом разделения ответственности.
   - Определение интерфейсов для взаимодействия с модулями "Пользователи" и "Доступы".
2. **Разработка:**
   - Реализация функционала аутентификации через Telegram и логин/пароль.
   - Реализация механизма получения `profile_completed` из модуля "Пользователи".
   - Реализация механизма контроля доступа на основе доступов.
3. **Тестирование:**
   - Разработка и выполнение функциональных тестов.
   - Проведение нагрузочного и безопасностного тестирования.
4. **Документирование:**
   - Обновление документации кода и API.
   - Создание документации по взаимодействию модулей.
5. **Внедрение:**
   - Развертывание модуля в тестовой среде.
   - Интеграция с модулями "Пользователи" и "Доступы".
   - Подготовка к переносу в продакшн.

### 10.2. Сроки и ресурсы

- **Сроки:** Ориентировочное время реализации — 3 недели.
- **Ресурсы:**
  - **Разработчики:** 2 backend-разработчика.
  - **Тестировщики:** 1 специалист.
  - **Администратор базы данных:** по необходимости.

---

## 11. Дополнительные замечания

- **Качество кода:** Соблюдение стандартов кодирования и стиля.
- **Обратная связь:** Регулярные встречи команды для обсуждения прогресса и решения проблем.
- **Риски:**
  - Изменения требований со стороны стейкхолдеров.
  - Возможные задержки из-за интеграции с другими модулями.
- **Будущие расширения:**
  - Предусмотрена возможность добавления новых методов аутентификации (OAuth, SSO и т.д.).
  - Возможность масштабирования модуля в отдельный сервис при росте нагрузки.